[gd_resource type="ShaderMaterial" load_steps=10 format=3 uid="uid://0lfqdgecvqr8"]

[ext_resource type="Texture2D" uid="uid://bf7chtw1jw4td" path="res://Assets/Textures/final_small_wave_normal.tres" id="1_0lmjb"]
[ext_resource type="Texture2D" uid="uid://bnl6nbdbg3g3u" path="res://Assets/Textures/wave.tres" id="1_jq4s7"]

[sub_resource type="Shader" id="Shader_bmssu"]
code = "shader_type spatial;
render_mode blend_mix, cull_back, diffuse_burley, specular_disabled;

uniform sampler2D wave_height_1;
uniform sampler2D wave_height_2;
uniform sampler2D normal_map_1 : hint_normal;
uniform sampler2D normal_map_2 : hint_normal;

uniform float world_scale = 10.0;

uniform float wave_speed_1 = 0.05;
uniform float wave_speed_2 = 0.025;
uniform float final_wave_speed = 0.5;
uniform float wave_scale_1 = 2.0;
uniform float wave_scale_2 = 1.0;
uniform float final_wave_scale = 1.0;

uniform float normal_mult = 0.1;
uniform float normal_height = 0.4;
uniform float normal_2_height = 0.3;

// LOD tuning for performance
uniform float normal_lod = 2.0;

uniform vec3 albedo : source_color = vec3(0.1, 0.2, 0.3);
uniform float roughness = 0.05;
uniform float transparency = 0.85;
uniform float specular = 1.0;
uniform float metallic = 0.5;

uniform float distance_fade_min : hint_range(0.0, 4096.0, 0.01);
uniform float distance_fade_max : hint_range(0.0, 4096.0, 0.01);

varying vec3 v_world_pos;

void vertex() {
	v_world_pos = (MODEL_MATRIX * vec4(VERTEX, 1.0)).xyz;

	// world-space UVs
	vec2 uv1 = (v_world_pos.xz / world_scale) + TIME * wave_speed_1 * final_wave_speed;
	vec2 uv2 = (v_world_pos.xz / world_scale) - TIME * wave_speed_2 * final_wave_speed;
	// multiple layer vertex displacement
	float h1 = texture(wave_height_1, uv1).r * wave_scale_1;
	float h2 = texture(wave_height_2, uv2).r * wave_scale_2;
	VERTEX.y += (h1 + h2) * final_wave_scale;
}

void fragment() {
	vec2 uv1 = (v_world_pos.xz / world_scale) + TIME * wave_speed_1 * final_wave_speed;
	vec2 uv2 = (v_world_pos.xz / world_scale) - TIME * wave_speed_2 * final_wave_speed;

	// Sample normal maps at lower LOD to save performance
	vec3 n1 = textureLod(normal_map_1, uv1, normal_lod).rgb * 2.0 - 1.0;
	vec3 n2 = textureLod(normal_map_2, uv2, normal_lod).rgb * 2.0 - 1.0;

	// Scale XY perturbation
	n1.xy *= normal_height;
	n2.xy *= normal_2_height;

	// Blend normals
	vec3 blended = normalize(n1 + n2);
	
	float dist = distance(VERTEX, VIEW);
	float fade = smoothstep(distance_fade_min, distance_fade_max, dist);
	
	// Apply as additive screen-space normal
	NORMAL = normalize(NORMAL + blended * normal_mult);

	// Shading
	ALBEDO = albedo;
	ROUGHNESS = roughness;
	SPECULAR = specular;
	METALLIC = metallic;
	ALPHA = transparency;
	ALPHA *= fade;
}
"

[sub_resource type="Gradient" id="Gradient_0glgx"]
interpolation_mode = 2
interpolation_color_space = 1
offsets = PackedFloat32Array(0, 0.3125, 1)
colors = PackedColorArray(0, 0, 0, 1, 0.5, 0.5, 0.5, 1, 1, 1, 1, 1)

[sub_resource type="FastNoiseLite" id="FastNoiseLite_7dmu6"]
seed = 7
frequency = 0.015
offset = Vector3(15.6, -30.5, 0)
fractal_type = 2
cellular_return_type = 6
domain_warp_enabled = true
domain_warp_amplitude = 32.0
domain_warp_frequency = 0.015
domain_warp_fractal_lacunarity = 1.155
domain_warp_fractal_gain = 0.995

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_jq4s7"]
width = 64
height = 64
in_3d_space = true
seamless = true
as_normal_map = true
color_ramp = SubResource("Gradient_0glgx")
noise = SubResource("FastNoiseLite_7dmu6")

[sub_resource type="Gradient" id="Gradient_g80pu"]
interpolation_mode = 2
interpolation_color_space = 1
offsets = PackedFloat32Array(0.0847458, 0.375, 0.711538, 1)
colors = PackedColorArray(0, 0, 0, 1, 0.3, 0.3, 0.3, 1, 0.7, 0.7, 0.7, 1, 1, 1, 1, 1)

[sub_resource type="FastNoiseLite" id="FastNoiseLite_53iab"]
frequency = 0.1
fractal_type = 3
fractal_octaves = 3
fractal_gain = -0.5
fractal_ping_pong_strength = 1.0
domain_warp_enabled = true
domain_warp_amplitude = 32.0
domain_warp_frequency = 0.015
domain_warp_fractal_lacunarity = 0.34

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_85chf"]
width = 64
height = 64
invert = true
in_3d_space = true
seamless = true
as_normal_map = true
bump_strength = 16.0
color_ramp = SubResource("Gradient_g80pu")
noise = SubResource("FastNoiseLite_53iab")

[resource]
render_priority = 0
shader = SubResource("Shader_bmssu")
shader_parameter/wave_height_1 = ExtResource("1_jq4s7")
shader_parameter/wave_height_2 = ExtResource("1_0lmjb")
shader_parameter/normal_map_1 = SubResource("NoiseTexture2D_jq4s7")
shader_parameter/normal_map_2 = SubResource("NoiseTexture2D_85chf")
shader_parameter/world_scale = 128.0
shader_parameter/wave_speed_1 = 0.1
shader_parameter/wave_speed_2 = 0.05
shader_parameter/final_wave_speed = 0.33
shader_parameter/wave_scale_1 = 2.5
shader_parameter/wave_scale_2 = 1.0
shader_parameter/final_wave_scale = 1.0
shader_parameter/normal_mult = 0.125
shader_parameter/normal_height = 0.5
shader_parameter/normal_2_height = 0.5
shader_parameter/normal_lod = 1.0
shader_parameter/albedo = Color(0.375, 0.40625, 0.5, 1)
shader_parameter/roughness = 0.05
shader_parameter/transparency = 0.5
shader_parameter/specular = 1.0
shader_parameter/metallic = 0.9
shader_parameter/distance_fade_min = 50.0
shader_parameter/distance_fade_max = 100.0
